name: CMake on Windows (vcpkg)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set reusable strings
        id: strings
        shell: bash
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      # ---------------------------
      # Install vcpkg and required packages (Windows)
      # ---------------------------
      - name: Install vcpkg and packages
        shell: powershell
        run: |
          # clone vcpkg
          git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE\vcpkg
          Set-Location $env:GITHUB_WORKSPACE\vcpkg

          # bootstrap with metrics disabled (keeps logs cleaner)
          .\bootstrap-vcpkg.bat -disableMetrics

          # Correct install syntax: <package>:<triplet>
          .\vcpkg.exe install libsodium:x64-windows cpr:x64-windows

          # Show installed packages (helps debugging)
          .\vcpkg.exe list

          # Expose toolchain file path for later steps
          Write-Output "VCPKG_TOOLCHAIN_FILE=$env:GITHUB_WORKSPACE\vcpkg\scripts\buildsystems\vcpkg.cmake" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # Optional: cache vcpkg folder to speed up subsequent runs
      # - name: Cache vcpkg
      #   uses: actions/cache@v4
      #   with:
      #     path: ${{ github.workspace }}\vcpkg
      #     key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}
      #     restore-keys: |
      #       vcpkg-${{ runner.os }}-

      # ---------------------------
      # Configure CMake (Windows) using vcpkg toolchain
      # ---------------------------
      - name: Configure CMake (Windows + vcpkg)
        shell: powershell
        run: |
          # Read vcpkg toolchain path from GITHUB_OUTPUT
          $toolchainEntry = Get-Content Env:GITHUB_OUTPUT | Select-String -Pattern "VCPKG_TOOLCHAIN_FILE=(.*)"
          $toolchain = $null
          if ($toolchainEntry) {
            $toolchain = $toolchainEntry.Matches[0].Groups[1].Value
          }

          # Prepare cmake args
          $cmakeArgs = @(
            "-B", "${{ steps.strings.outputs.build-output-dir }}",
            "-S", "${{ github.workspace }}",
            "-A", "x64",
            "-DCMAKE_BUILD_TYPE=Release"
          )

          if ($toolchain -and (Test-Path $toolchain)) {
            $cmakeArgs += ("-DCMAKE_TOOLCHAIN_FILE=$toolchain")
            Write-Host "Using vcpkg toolchain: $toolchain"
          } else {
            Write-Host "No vcpkg toolchain found; configuring without it (unexpected)."
          }

          # Run CMake configure
          cmake @cmakeArgs

      # ---------------------------
      # Build (multi-config, pass --config)
      # ---------------------------
      - name: Build
        shell: powershell
        run: |
          cmake --build "${{ steps.strings.outputs.build-output-dir }}" --config Release -- /m

      # ---------------------------
      # Test
      # ---------------------------
      - name: Test
        shell: powershell
        working-directory: ${{ steps.strings.outputs.build-output-dir }}
        run: |
          ctest --config Release --output-on-failure
